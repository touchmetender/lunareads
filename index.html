<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåô Luna Reads</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/* ===== BODY & VIEWS ===== */
body{margin:0;font-family:sans-serif;background:#0f0f0f;color:white;}
.view{position:absolute;width:100%;height:100vh;top:0;left:0;}
.hidden{display:none;}

/* ===== HEADER ===== */
.header{display:flex;align-items:center;gap:10px;padding:10px;background:#1a1a1a;position:fixed;top:0;width:100%;z-index:10;}
.header input,.header select{padding:6px;border-radius:6px;border:none;}

/* ===== SECTIONS ===== */
.section-title{padding: 90px 12px 12px 12px;font-weight:bold;} /* 72px for header space */
.horizontal{display:flex;overflow-x:auto;gap:12px;padding:12px; padding-bottom: 12px; padding-top: 12px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;padding:12px;overflow-y:auto;;padding-bottom: 80px; padding-top: 120px;}
.card{background:#1b1b1b;border-radius:12px;overflow:hidden;cursor:pointer;min-width:140px;max-width: 140px; position:relative;}
.card img{width:100%;}
.card-info{padding:4px;}
.progress{height:4px;background:#00e676;}
.badge{position:absolute;top:8px;left:8px;background:#00e676;padding:4px 6px;font-size:10px;border-radius:6px;}

/* ===== READER ===== */
.reader-header{height:56px;background:#121212;display:flex;align-items:center;justify-content:space-between;padding:0 1px;border-bottom:1px solid #222;position:fixed;top:0;width:100%;z-index:10;}
.reader-header button{background:none;border:none;color:white;font-size:18px;}
#reader{height:100vh;overflow-y:auto;padding:10px;display:flex;flex-wrap:wrap;justify-content:center;scroll-snap-type:y mandatory;scroll-behavior:smooth;margin-top:0;padding-bottom: 80px; padding-top: 80px;}
canvas{margin-bottom:10px;max-width:100%;}

/* ===== MENU ===== */
.menu{position:absolute;top:56px;right:10px;background:#1b1b1b;padding:10px;border-radius:8px;display:none;flex-direction:column;gap:8px;z-index:11;}
.menu button{padding:6px;background:#2962ff;border:none;color:white;border-radius:6px;}
#downloadProgress{height:6px;background:#00e676;width:0%;border-radius:4px;margin-top:4px;}

/* ===== BOTTOM NAV ===== */
.bottom-nav{position:fixed;bottom:0;width:100%;display:flex;justify-content:space-around;align-items:center;height:60px;background:rgba(18,18,18, 0.95);z-index:10;}
.bottom-nav button{background:none;border:none;color:white;font-size:20px;display:flex;align-items:center;justify-content:center;width:60px;height:40px;border-radius:10px;}
.bottom-nav .middle{width:60px;height:60px;border-radius:50%;background:#2962ff;font-size:40px;display:flex;align-items:center;justify-content:center;margin-top:-20px;}
</style>
</head>
<body>

<!-- HOME VIEW -->
<div id="homeView" class="view">
  <div class="header" id="headerHome">
    <h2>üåô Luna Reads</h2>
    <input id="searchInput" placeholder="Search">
    <select id="categoryFilter">
      <option value="All">All</option>
      <option value="Manga">Manga</option>
      <option value="Manhwa">Manhwa</option>
      <option value="Manhua">Manhua</option>
      <option value="Book">Book</option>
    </select>
  </div>

  <div class="section-title">Continue Reading...</div>
  <div id="continueRow" class="horizontal"></div>

  <div class="section-title">Recently Added Books / Ebooks / Manga / Manhwa / Manhua / Stories</div>
  <div id="recentRow" class="horizontal"></div>

  <div class="section-title">Browse Library</div>
  <div id="grid" class="grid"></div>
</div>

<!-- BROWSE VIEW -->
<div id="browseView" class="view hidden">
  <div class="header" id="headerBrowse">
    <h2>üåô Luna Reads</h2>
    <input id="searchInputBrowse" placeholder="Search">
    <select id="categoryFilterBrowse">
      <option value="All">All</option>
      <option value="Manga">Manga</option>
      <option value="Manhwa">Manhwa</option>
      <option value="Manhua">Manhua</option>
      <option value="Book">Book</option>
    </select>
    <select id="sortBrowse">
      <option value="updated">Updated Time</option>
      <option value="alphabet">Alphabetical</option>
      <option value="downloaded">Downloaded</option>
    </select>
  </div>
  <div id="browseGrid" class="grid"></div>
</div>

<!-- MENU VIEW -->
<div id="menuView" class="view hidden">
  <div style="padding:12px;">
    <h2>‚öôÔ∏è Settings</h2>
    <div id="downloadManager"></div>
    
    <!-- Clear Data Button -->
    <div style="margin-top:20px;">
      <button id="clearAppDataBtn" style="padding:10px; background:#ff3d00; color:white; border:none; border-radius:6px; font-weight:bold;">
        üóëÔ∏è Clear All App Data
      </button>
    </div>
  </div>
</div>

<!-- READER VIEW -->
<div id="readerView" class="view hidden">
  <div class="reader-header">
    <button onclick="goBack()">‚Üê Back</button>
    <span id="readerTitle"></span>
    <button onclick="toggleMenu()">‚ò∞ Menu</button>
  </div>
  <div id="reader"></div>
  <div id="readerMenu" class="menu">
    <button onclick="setMode('scroll')">Scroll Mode</button>
    <button onclick="setMode('double')">2-Page Spread</button>
    <button onclick="setMode('single')">Single Page</button>
    <button onclick="toggleSnap()">Toggle Snap</button>
    <button onclick="downloadCurrent()">Download Offline</button>
    <button onclick="openDownloads()">Manage Downloads</button>
    <div id="downloadProgress"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button onclick="showView('browseView')">üìö Browse</button>
  <button class="middle" onclick="showView('homeView')">üè†</button>
  <button onclick="showView('menuView')">‚öôÔ∏è Settings</button>
</div>

<!-- Notification container -->
<div id="notification" style="
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:#ff5252;
  color:white;
  padding:12px 20px;
  border-radius:10px;
  font-weight:bold;
  display:none;
  z-index:9999;
  box-shadow:0 4px 8px rgba(0,0,0,0.3);
"></div>  
  
<script>
  
function showNotification(message, duration = 3000) {
  const notif = document.getElementById("notification");
  notif.innerText = message;
  notif.style.display = "block";

  setTimeout(() => {
    notif.style.display = "none";
  }, duration);
}
  
// ================= SERVICE WORKER =================
if('serviceWorker' in navigator){navigator.serviceWorker.register("service-worker.js").then(r=>r.update());}

// ================= VARIABLES =================
let LIBRARY=[],currentBook=null,currentPDF=null,renderedPages={},readingMode="scroll",historyData=JSON.parse(localStorage.getItem("lunaHistory")||"{}"),snapEnabled=false;

// ================= FETCH LIBRARY =================
async function loadLibrary(){
  const res=await fetch("library.json?t="+Date.now());
  LIBRARY=await res.json();
  renderHome();renderBrowse();renderDownloads();
}

// ================= RENDER HOME =================
function renderHome(){
  const grid=document.getElementById("grid"),continueRow=document.getElementById("continueRow"),recentRow=document.getElementById("recentRow");
  grid.innerHTML="";continueRow.innerHTML="";recentRow.innerHTML="";
  const search=document.getElementById("searchInput").value.toLowerCase();
  const category=document.getElementById("categoryFilter").value;
  const sorted=[...LIBRARY].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  sorted.slice(0,5).forEach(b=>recentRow.appendChild(createCard(b)));
  LIBRARY.forEach(book=>{
    if(book.title.toLowerCase().includes(search)&&(category==="All"||book.category===category)){
      grid.appendChild(createCard(book));
    }
    if(historyData[book.id]?.scroll) continueRow.appendChild(createCard(book));
  });
}
document.getElementById("searchInput").oninput=renderHome;
document.getElementById("categoryFilter").onchange=renderHome;

// ================= RENDER BROWSE =================
function renderBrowse(){
  const grid=document.getElementById("browseGrid");
  grid.innerHTML="";
  const search=document.getElementById("searchInputBrowse").value.toLowerCase();
  const category=document.getElementById("categoryFilterBrowse").value;
  const sort=document.getElementById("sortBrowse").value;
  let books=[...LIBRARY].filter(b=>b.title.toLowerCase().includes(search)&&(category==="All"||b.category===category));
  if(sort==="alphabet") books.sort((a,b)=>a.title.localeCompare(b.title));
  else if(sort==="updated") books.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  else if(sort==="downloaded") books.sort((a,b)=>isDownloaded(b.id)?-1:1);
  books.forEach(b=>grid.appendChild(createCard(b)));
}
document.getElementById("searchInputBrowse").oninput=renderBrowse;
document.getElementById("categoryFilterBrowse").onchange=renderBrowse;
document.getElementById("sortBrowse").onchange=renderBrowse;

// ================= CREATE CARD =================
function createCard(book){
  const card=document.createElement("div");card.className="card";
  const progress=historyData[book.id]?.progress||0;
  card.innerHTML=`${isDownloaded(book.id)?'<div class="badge">DOWNLOADED</div>':''}
  <img src="${book.coverUrl}">
  <div class="progress" style="width:${progress}%"></div>
  <div class="card-info">${book.title}</div>`;
  card.onclick=()=>openReader(book);
  return card;
}

// ================= SHOW TAB =================
function showView(id){
  ['homeView','browseView','menuView','readerView'].forEach(v=>document.getElementById(v).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  // hide header on menu & reader
  document.getElementById("headerHome").style.display=(id==='homeView')?'flex':'none';
  document.getElementById("headerBrowse").style.display=(id==='browseView')?'flex':'none';
  document.body.style.overflow=(id==='readerView')?'hidden':'auto';
}

// ================= READER =================
async function openReader(book){
  currentBook=book;renderedPages={};readingMode=historyData[book.id]?.mode||"scroll";
  showView('readerView');document.getElementById("readerTitle").innerText=book.title;
  const reader=document.getElementById("reader");reader.innerHTML="";reader.scrollTop=historyData[book.id]?.scroll||0;
  const offline=await getFile(book.id);const fileData=offline?offline:book.fileUrl;
  if(book.fileType==="pdf"){
    const arrayBuffer=offline?await offline.arrayBuffer():null;
    currentPDF=await pdfjsLib.getDocument(offline?{data:new Uint8Array(arrayBuffer)}:fileData).promise;
    createLazyPages();reader.addEventListener("scroll",handleLazyLoad);handleLazyLoad();
  }
  if(book.fileType==="epub"){
    const url=offline?URL.createObjectURL(offline):book.fileUrl;
    const bookEPUB=ePub(url);bookEPUB.renderTo("reader",{width:"100%",height:"100%"});
  }
  if(book.fileType==="cbz"){
    const blob=offline?offline:await fetch(fileData).then(r=>r.blob());
    const zip=await JSZip.loadAsync(blob);
    for(const name of Object.keys(zip.files)){
      if(name.match(/\.(jpg|jpeg|png)$/)){
        const imgBlob=await zip.files[name].async("blob");
        const img=document.createElement("img");
        img.src=URL.createObjectURL(imgBlob);
        img.style.maxWidth="100%";
        reader.appendChild(img);
      }
    }
  }
}

// ================= PDF LAZY =================
function createLazyPages(){
  const reader=document.getElementById("reader");
  for(let i=1;i<=currentPDF.numPages;i++){
    const div=document.createElement("div");div.id="page-"+i;div.style.minHeight="800px";
    if(readingMode==="double" && window.innerWidth>900){div.style.flex="0 0 48%";div.style.margin="1%";}
    else{div.style.width="100%";}
    reader.appendChild(div);
  }
}
async function handleLazyLoad(){
  const reader=document.getElementById("reader");const pages=document.querySelectorAll("[id^='page-']");const vh=window.innerHeight;
  for(const div of pages){
    const rect=div.getBoundingClientRect();
    if(rect.top<vh+300 && rect.bottom>-300){
      const num=parseInt(div.id.split("-")[1]);
      if(!renderedPages[num]){
        const page=await currentPDF.getPage(num);
        const viewport=page.getViewport({scale:(window.innerWidth-40)/page.getViewport({scale:1}).width});
        const canvas=document.createElement("canvas");
        canvas.width=viewport.width;canvas.height=viewport.height;
        await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;
        div.innerHTML="";div.appendChild(canvas);renderedPages[num]=true;
      }
    }
  }
  saveProgress();
}

// ================= SAVE =================
function saveProgress(){
  const reader=document.getElementById("reader");
  if(!currentBook) return;
  historyData[currentBook.id]=historyData[currentBook.id]||{};
  historyData[currentBook.id].scroll=reader.scrollTop;
  const percent=(reader.scrollTop/(reader.scrollHeight-reader.clientHeight))*100;
  historyData[currentBook.id].progress=percent;
  localStorage.setItem("lunaHistory",JSON.stringify(historyData));
}

// ================= READER MENU =================
function toggleMenu(){const m=document.getElementById("readerMenu");m.style.display=m.style.display==="flex"?"none":"flex";}
function setMode(mode){readingMode=mode;historyData[currentBook.id]=historyData[currentBook.id]||{};historyData[currentBook.id].mode=mode;localStorage.setItem("lunaHistory",JSON.stringify(historyData));document.getElementById("reader").innerHTML="";renderedPages={};if(currentBook.fileType==="pdf") createLazyPages();}
function toggleSnap(){snapEnabled=!snapEnabled;document.getElementById("reader").style.scrollSnapType=snapEnabled?"y mandatory":"none";}
function goBack(){showView('homeView');currentBook=null;}

// ================= DOWNLOAD =================
async function downloadCurrent(){
  const response=await fetch(currentBook.fileUrl);const readerStream=response.body.getReader();const contentLength=response.headers.get("Content-Length");let received=0;let chunks=[];
  while(true){const {done,value}=await readerStream.read();if(done)break;chunks.push(value);received+=value.length;document.getElementById("downloadProgress").style.width=Math.round(received/contentLength*100)+"%";}
  const blob=new Blob(chunks);
  const db=await openDB();db.transaction("files","readwrite").objectStore("files").put(blob,currentBook.id);
  historyData[currentBook.id]=historyData[currentBook.id]||{};historyData[currentBook.id].downloaded=true;localStorage.setItem("lunaHistory",JSON.stringify(historyData));
  document.getElementById("downloadProgress").style.width="0%";
  renderHome();renderBrowse();renderDownloads();
}

// ================= DOWNLOAD MANAGER =================
async function renderDownloads(){
  const manager=document.getElementById("downloadManager");
  const db=await openDB();
  const tx=db.transaction("files","readonly");
  const store=tx.objectStore("files");
  const keys=await new Promise(res=>{const r=[];store.openCursor().onsuccess=e=>{const cursor=e.target.result;if(cursor){r.push(cursor.key);cursor.continue();}else res(r);};});
  manager.innerHTML="<h3>üì• Downloads</h3>";
  if(keys.length===0){manager.innerHTML+="<p>No downloads yet.</p>";return;}
  for(const id of keys){
    const book=LIBRARY.find(b=>b.id===id);if(!book)continue;
    const div=document.createElement("div");div.style.display="flex";div.style.justifyContent="space-between";div.style.alignItems="center";div.style.padding="6px 0";
    div.innerHTML=`<span>${book.title}</span><button onclick="deleteDownload('${id}')">üóëÔ∏è Delete</button>`;
    manager.appendChild(div);
  }
}
async function deleteDownload(id){
  const db=await openDB();
  const tx=db.transaction("files","readwrite");
  tx.objectStore("files").delete(id);
  delete historyData[id]?.downloaded;
  localStorage.setItem("lunaHistory",JSON.stringify(historyData));
  renderDownloads();renderHome();renderBrowse();
}

// ================= INDEXEDDB =================
function openDB(){return new Promise(resolve=>{const request=indexedDB.open("LunaReadsDB",1);request.onupgradeneeded=e=>{e.target.result.createObjectStore("files");};request.onsuccess=e=>resolve(e.target.result);});}
async function getFile(id){const db=await openDB();return new Promise(resolve=>{const tx=db.transaction("files","readonly");const req=tx.objectStore("files").get(id);req.onsuccess=()=>resolve(req.result||null);});}
function isDownloaded(id){return !!historyData[id]?.downloaded;}


// ================= INIT =================
loadLibrary();
  
document.getElementById("clearAppDataBtn").onclick = async function() {
  if (!confirm("Are you sure you want to clear all app data? This cannot be undone.")) return;

  // 1. Clear localStorage
  localStorage.clear();

  // 2. Clear IndexedDB
  if (window.indexedDB) {
    const dbDeleteRequest = indexedDB.deleteDatabase("LunaReadsDB");
    dbDeleteRequest.onsuccess = () => console.log("IndexedDB deleted successfully");
    dbDeleteRequest.onerror = () => console.log("Error deleting IndexedDB");
  }

  // 3. Clear Service Worker caches
  if ('caches' in window) {
    const cacheNames = await caches.keys();
    for (const name of cacheNames) {
      await caches.delete(name);
    }
    console.log("All caches deleted");
  }

  showNotification("‚úÖ All app data cleared. Reloading...", 4000);
  setTimeout(() => location.reload(), 1000); // short delay to let user see notification
};
</script>

</body>
</html>
