<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luna Reads</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#0f0f0f;
  color:white;
}

/* Views */
.view{
  position:absolute;
  width:100%;
  height:100vh;
  top:0;
  left:0;
}
.hidden{display:none;}

/* Home */
.topbar{
  background:#1a1a1a;
  padding:10px;
  display:flex;
  gap:10px;
  align-items:center;
}
.topbar input, .topbar select{
  padding:6px;
  border-radius:6px;
  border:none;
}

.section-title{
  padding:12px;
  font-weight:bold;
}

.horizontal{
  display:flex;
  overflow-x:auto;
  gap:12px;
  padding:12px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:12px;
  padding:12px;
  overflow-y:auto;
  height:calc(100vh - 220px);
}

.card{
  background:#1b1b1b;
  border-radius:12px;
  overflow:hidden;
  cursor:pointer;
  min-width:140px;
}

.card img{width:100%;}
.card-info{padding:8px;}
.progress{height:4px;background:#00e676;}

/* Reader */
.reader-header{
  height:56px;
  background:#121212;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  border-bottom:1px solid #222;
}

.reader-header button{
  background:none;
  border:none;
  color:white;
  font-size:18px;
}

#reader{
  height:calc(100vh - 56px);
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}

canvas{
  margin-bottom:10px;
  max-width:100%;
}

/* Menu */
.menu{
  position:absolute;
  top:56px;
  right:10px;
  background:#1b1b1b;
  padding:10px;
  border-radius:8px;
  display:none;
  flex-direction:column;
  gap:8px;
}
.menu button{
  padding:6px;
  background:#2962ff;
  border:none;
  color:white;
  border-radius:6px;
}
</style>
</head>
<body>

<!-- HOME -->
<div id="libraryView" class="view">
  <div class="topbar">
    <h2>üåô Luna Reads</h2>
    <input id="searchInput" placeholder="Search">
    <select id="categoryFilter">
      <option value="All">All</option>
      <option value="Manga">Manga</option>
      <option value="Manhwa">Manhwa</option>
      <option value="Manhua">Manhua</option>
      <option value="Book">Book</option>
    </select>
  </div>

  <div class="section-title">Continue Reading</div>
  <div id="continueRow" class="horizontal"></div>

  <div class="section-title">Recently Added</div>
  <div id="recentRow" class="horizontal"></div>

  <div class="section-title">Library</div>
  <div id="grid" class="grid"></div>
</div>

<!-- READER -->
<div id="readerView" class="view hidden">
  <div class="reader-header">
    <button onclick="goBack()">‚Üê</button>
    <span id="readerTitle"></span>
    <button onclick="toggleMenu()">‚ò∞</button>
  </div>

  <div id="reader"></div>

  <div id="readerMenu" class="menu">
    <button onclick="setMode('scroll')">Scroll Mode</button>
    <button onclick="setMode('double')">2-Page Spread</button>
    <button onclick="setMode('single')">Single Page</button>
    <button onclick="downloadCurrentPDF()">Download Offline</button>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let LIBRARY=[];
let currentBook=null;
let currentPDF=null;
let renderedPages={};
let baseScale=1;
let readingMode="scroll";
let historyData=JSON.parse(localStorage.getItem("lunaHistory"))||{};

/* ================= LOAD LIBRARY ================= */

async function loadLibrary(){
  const res=await fetch("library.json");
  LIBRARY=await res.json();
  renderLibrary();
}

function renderLibrary(){
  const grid=document.getElementById("grid");
  const continueRow=document.getElementById("continueRow");
  const recentRow=document.getElementById("recentRow");
  grid.innerHTML="";
  continueRow.innerHTML="";
  recentRow.innerHTML="";

  const search=document.getElementById("searchInput").value.toLowerCase();
  const category=document.getElementById("categoryFilter").value;

  const sorted=[...LIBRARY].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  sorted.slice(0,5).forEach(b=>recentRow.appendChild(createCard(b)));

  LIBRARY.forEach(book=>{
    if(
      book.title.toLowerCase().includes(search) &&
      (category==="All" || book.category===category)
    ){
      grid.appendChild(createCard(book));
    }
    if(historyData[book.id]) continueRow.appendChild(createCard(book));
  });
}

document.getElementById("searchInput").oninput=renderLibrary;
document.getElementById("categoryFilter").onchange=renderLibrary;

function createCard(book){
  const card=document.createElement("div");
  card.className="card";
  const progress=historyData[book.id]?.progress||0;
  card.innerHTML=`
    <img src="${book.coverUrl}">
    <div class="progress" style="width:${progress}%"></div>
    <div class="card-info">${book.title}</div>
  `;
  card.onclick=()=>openReader(book);
  return card;
}

/* ================= OPEN READER ================= */

async function openReader(book){
  currentBook=book;
  renderedPages={};
  readingMode=historyData[book.id]?.mode||"scroll";

  document.getElementById("libraryView").classList.add("hidden");
  document.getElementById("readerView").classList.remove("hidden");
  document.getElementById("readerTitle").innerText=book.title;

  const reader=document.getElementById("reader");
  reader.innerHTML="";
  reader.scrollTop=historyData[book.id]?.scroll||0;

  let fileData=await getOfflinePDF(book.id);
  if(!fileData){
    fileData=book.fileUrl;
  }

  currentPDF=await pdfjsLib.getDocument(fileData).promise;

  const firstPage=await currentPDF.getPage(1);
  const viewport=firstPage.getViewport({scale:1});
  baseScale=(window.innerWidth-40)/viewport.width;

  createLazyPages();
  reader.addEventListener("scroll",handleLazyLoad);
  handleLazyLoad();
}

/* ================= READING MODES ================= */

function setMode(mode){
  readingMode=mode;
  historyData[currentBook.id]=historyData[currentBook.id]||{};
  historyData[currentBook.id].mode=mode;
  localStorage.setItem("lunaHistory",JSON.stringify(historyData));
  document.getElementById("reader").innerHTML="";
  renderedPages={};
  createLazyPages();
  handleLazyLoad();
}

function createLazyPages(){
  const reader=document.getElementById("reader");
  for(let i=1;i<=currentPDF.numPages;i++){
    const div=document.createElement("div");
    div.id="page-"+i;
    div.style.minHeight="800px";

    if(readingMode==="double" && window.innerWidth>900){
      div.style.flex="0 0 48%";
      div.style.margin="1%";
    }else{
      div.style.width="100%";
    }

    reader.appendChild(div);
  }
}

/* ================= LAZY LOAD ================= */

async function handleLazyLoad(){
  const reader=document.getElementById("reader");
  const pages=document.querySelectorAll("[id^='page-']");
  const vh=window.innerHeight;

  pages.forEach(async div=>{
    const rect=div.getBoundingClientRect();
    if(rect.top<vh+300 && rect.bottom>-300){
      const num=parseInt(div.id.split("-")[1]);
      if(!renderedPages[num]){
        const page=await currentPDF.getPage(num);
        const viewport=page.getViewport({scale:baseScale});
        const canvas=document.createElement("canvas");
        canvas.width=viewport.width;
        canvas.height=viewport.height;
        await page.render({
          canvasContext:canvas.getContext("2d"),
          viewport
        }).promise;
        div.innerHTML="";
        div.appendChild(canvas);
        renderedPages[num]=true;
      }
    }
  });

  saveProgress();
}

/* ================= SAVE ================= */

function saveProgress(){
  const reader=document.getElementById("reader");
  historyData[currentBook.id]=historyData[currentBook.id]||{};
  historyData[currentBook.id].scroll=reader.scrollTop;

  const percent=(reader.scrollTop/(reader.scrollHeight-reader.clientHeight))*100;
  historyData[currentBook.id].progress=percent;

  localStorage.setItem("lunaHistory",JSON.stringify(historyData));
}

/* ================= MENU ================= */

function toggleMenu(){
  const m=document.getElementById("readerMenu");
  m.style.display=m.style.display==="flex"?"none":"flex";
}

/* ================= OFFLINE DOWNLOAD ================= */

async function downloadCurrentPDF(){
  const response=await fetch(currentBook.fileUrl);
  const blob=await response.blob();
  const db=await openDB();
  const tx=db.transaction("pdfs","readwrite");
  tx.objectStore("pdfs").put(blob,currentBook.id);
  alert("Downloaded for offline use");
}

function openDB(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open("LunaReadsDB",1);
    request.onupgradeneeded=e=>{
      const db=e.target.result;
      db.createObjectStore("pdfs");
    };
    request.onsuccess=e=>resolve(e.target.result);
    request.onerror=e=>reject(e);
  });
}

async function getOfflinePDF(id){
  const db=await openDB();
  return new Promise(resolve=>{
    const tx=db.transaction("pdfs","readonly");
    const req=tx.objectStore("pdfs").get(id);
    req.onsuccess=()=>resolve(req.result||null);
  });
}

/* ================= BACK ================= */

function goBack(){
  document.getElementById("readerView").classList.add("hidden");
  document.getElementById("libraryView").classList.remove("hidden");
  currentBook=null;
}

loadLibrary();
</script>

</body>
</html>
