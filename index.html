<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luna Reads Ultimate PWA</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- EPUB.js -->
<script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
<!-- JSZip for CBZ/CBR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2962ff">

<!-- Service Worker registration -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
  .then(()=>console.log('Service Worker registered!'))
  .catch(err=>console.error(err));
}
</script>

<style>
body{margin:0;font-family:sans-serif;background:#0f0f0f;color:white;}
.hidden{display:none;}
.topbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:#1a1a1a;}
input,select{padding:8px;border:none;border-radius:6px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;padding:12px;}
.card{background:#1b1b1b;border-radius:12px;overflow:hidden;cursor:pointer;}
.card img{width:100%;}
.card-info{padding:8px;}
.horizontal-scroll{display:flex;overflow-x:auto;gap:12px;padding:12px;}
.horizontal-scroll .card{min-width:140px;}
.progress-bar{height:5px;background:#00e676;}
#reader{height:100vh;overflow-y:auto;padding:10px;display:flex;flex-wrap:wrap;justify-content:center;}
canvas,img{margin-bottom:10px;}
.back-btn{padding:10px;background:#2962ff;color:white;border:none;border-radius:6px;margin:10px;}
.zoom-controls{position:fixed;top:80px;right:10px;display:flex;flex-direction:column;gap:8px;z-index:999;}
.zoom-controls button{padding:6px;}
</style>
</head>
<body>

<div id="libraryView">
<div class="topbar">
<h2>üåô Luna Reads</h2>
<input id="searchInput" placeholder="Search">
<select id="categoryFilter">
<option value="All">All</option>
<option value="Manga">Manga</option>
<option value="Manhwa">Manhwa</option>
<option value="Manhua">Manhua</option>
<option value="Book">Book</option>
<option value="Original">Original</option>
</select>
</div>

<h3 style="padding-left:12px;">Continue Reading</h3>
<div id="continueRow" class="horizontal-scroll"></div>

<h3 style="padding-left:12px;">Recently Added</h3>
<div id="recentRow" class="horizontal-scroll"></div>

<h3 style="padding-left:12px;">Library</h3>
<div id="grid" class="grid"></div>
</div>

<div id="readerView" class="hidden">
<button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
<div class="zoom-controls">
<button onclick="zoomIn()">üîç+</button>
<button onclick="zoomOut()">üîç-</button>
</div>
<div id="reader"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let LIBRARY=[];
let historyData=JSON.parse(localStorage.getItem("lunaHistory"))||{};
let currentBook=null;
let currentPDF=null;
let renderedPages={};
let currentScale=1.5;
const MIN_SCALE=1.0;
const MAX_SCALE=3.0;
let preloadOffset=2; // preload next 2 pages for smooth reading

/* ================= LIBRARY ================= */
async function loadLibrary(){
  try{
    const res=await fetch("library.json",{cache:'no-cache'});
    LIBRARY=await res.json();
    renderLibrary();
  } catch(e){
    console.error("Could not fetch library.json",e);
    LIBRARY=[];
    renderLibrary();
  }
}

function saveHistory(){
  localStorage.setItem("lunaHistory",JSON.stringify(historyData));
}

function renderLibrary(){
  const grid=document.getElementById("grid");
  const continueRow=document.getElementById("continueRow");
  const recentRow=document.getElementById("recentRow");
  grid.innerHTML="";
  continueRow.innerHTML="";
  recentRow.innerHTML="";

  const search=document.getElementById("searchInput").value.toLowerCase();
  const category=document.getElementById("categoryFilter").value;

  const sorted=[...LIBRARY].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));

  sorted.slice(0,5).forEach(b=>recentRow.appendChild(createCard(b)));
  LIBRARY.forEach(b=>{
    if(b.title.toLowerCase().includes(search) && (category==="All"||b.category===category)){
      grid.appendChild(createCard(b));
    }
    if(historyData[b.id]) continueRow.appendChild(createCard(b));
  });
}

document.getElementById("searchInput").oninput=renderLibrary;
document.getElementById("categoryFilter").onchange=renderLibrary;

function createCard(book){
  const progress=historyData[book.id]?.page||0;
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
  <img src="${book.coverUrl}">
  <div class="progress-bar" style="width:${progress}%"></div>
  <div class="card-info">
  <h4>${book.title}</h4>
  <small>${book.category}</small>
  </div>`;
  card.onclick=()=>openReader(book);
  return card;
}

/* ================= READER ================= */
async function openReader(book){
  currentBook=book;
  renderedPages={};
  currentScale=1.5;

  document.getElementById("libraryView").classList.add("hidden");
  document.getElementById("readerView").classList.remove("hidden");

  const reader=document.getElementById("reader");
  reader.innerHTML="";
  reader.scrollTop=0;

  if(book.fileType==="pdf"){
    currentPDF=await pdfjsLib.getDocument(book.fileUrl).promise;
    for(let i=1;i<=currentPDF.numPages;i++){
      const div=document.createElement("div");
      div.id="page-"+i;
      div.style.minHeight="800px";
      div.style.flex="0 0 48%"; // double-page
      div.style.margin="1%";
      reader.appendChild(div);
    }
    reader.addEventListener("scroll",handleScroll);
    handleScroll();
    const lastPage=historyData[book.id]?.page||1;
    setTimeout(()=>{
      const pageEl=document.getElementById("page-"+lastPage);
      if(pageEl) pageEl.scrollIntoView();
    },500);
    enableSwipe(reader);
  }

  if(book.fileType==="epub"){
    const bookEpub=ePub(book.fileUrl);
    const rendition=bookEpub.renderTo("reader",{width:"100%",height:"100%"});
    rendition.display(historyData[book.id]?.cfi||undefined);
    rendition.on("relocated",location=>{
      historyData[book.id]={cfi:location.start.cfi};
      saveHistory();
    });
  }

  if(book.fileType==="cbz"){
    await renderCBZ(book.fileUrl);
    enableSwipe(reader);
  }
}

/* ================= PDF LAZY + PRELOAD ================= */
async function handleScroll(){
  const reader=document.getElementById("reader");
  const pages=document.querySelectorAll("[id^='page-']");
  const viewportHeight=window.innerHeight;

  pages.forEach(async div=>{
    const rect=div.getBoundingClientRect();
    if(rect.top<viewportHeight+500 && rect.bottom>-500){
      const pageNum=parseInt(div.id.split("-")[1]);
      if(!renderedPages[pageNum]){
        const page=await currentPDF.getPage(pageNum);
        const viewport=page.getViewport({scale:currentScale});
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        canvas.width=viewport.width;
        canvas.height=viewport.height;
        await page.render({canvasContext:ctx,viewport}).promise;
        div.innerHTML="";
        div.appendChild(canvas);
        renderedPages[pageNum]=true;

        // preload next pages
        for(let offset=1; offset<=preloadOffset; offset++){
          const next=pageNum+offset;
          if(next<=currentPDF.numPages && !renderedPages[next]){
            const nextPage=await currentPDF.getPage(next);
            const nextViewport=nextPage.getViewport({scale:currentScale});
            const nextCanvas=document.createElement("canvas");
            nextCanvas.width=nextViewport.width;
            nextCanvas.height=nextViewport.height;
            await nextPage.render({canvasContext:nextCanvas.getContext("2d"),viewport:nextViewport}).promise;
            document.getElementById("page-"+next).appendChild(nextCanvas);
            renderedPages[next]=true;
          }
        }
      }
    }
  });

  detectCurrentPage();
}

function detectCurrentPage(){
  const pages=document.querySelectorAll("[id^='page-']");
  let closestPage=1;
  let minDistance=Infinity;
  pages.forEach(div=>{
    const rect=div.getBoundingClientRect();
    const distance=Math.abs(rect.top);
    if(distance<minDistance){
      minDistance=distance;
      closestPage=parseInt(div.id.split("-")[1]);
    }
  });
  historyData[currentBook.id]={page:closestPage};
  saveHistory();
}

/* ================= ZOOM ================= */
/*function zoomIn(){ if(currentScale+0.2>MAX_SCALE) return; currentScale+=0.2; rerenderPDF(); }
function zoomOut(){ if(currentScale-0.2<MIN_SCALE) return; currentScale-=0.2; rerenderPDF(); }

async function rerenderPDF(){
  if(!currentBook || currentBook.fileType!=="pdf") return;
  const reader=document.getElementById("reader");
  reader.innerHTML="";
  renderedPages={};
  handleScroll();
  const lastPage=historyData[currentBook.id]?.page||1;
  setTimeout(()=>{
    const pageEl=document.getElementById("page-"+lastPage);
    if(pageEl) pageEl.scrollIntoView();
  },500);
}

/* ================= CBZ ================= */
async function renderCBZ(url){
  const response=await fetch(url);
  const arrayBuffer=await response.arrayBuffer();
  const zip=new JSZip();
  const content=await zip.loadAsync(arrayBuffer);
  const images=Object.keys(content.files).filter(f=>/\.(png|jpg|jpeg)$/i.test(f)).sort();
  const reader=document.getElementById("reader");
  images.forEach(async f=>{
    const imgData=await content.files[f].async("base64");
    const img=document.createElement("img");
    img.src="data:image/png;base64,"+imgData;
    img.style.width="48%"; // double-page spread
    img.style.margin="1%";
    reader.appendChild(img);
  });
}

/* ================= SWIPE ================= */
function enableSwipe(container){
  let startX=0;
  container.addEventListener("touchstart",e=>{startX=e.touches[0].clientX;});
  container.addEventListener("touchend",e=>{
    let endX=e.changedTouches[0].clientX;
    if(endX-startX>50) scrollPrevPage();
    else if(startX-endX>50) scrollNextPage();
  });
}

function scrollNextPage(){document.getElementById("reader").scrollBy({top:window.innerHeight,behavior:"smooth"});}
function scrollPrevPage(){document.getElementById("reader").scrollBy({top:-window.innerHeight,behavior:"smooth"});}

/* ================= BACK ================= */
function goBack(){
  document.getElementById("readerView").classList.add("hidden");
  document.getElementById("libraryView").classList.remove("hidden");
  const reader=document.getElementById("reader");
  reader.removeEventListener("scroll",handleScroll);
  renderLibrary();
}

loadLibrary();
</script>
</body>
</html>
